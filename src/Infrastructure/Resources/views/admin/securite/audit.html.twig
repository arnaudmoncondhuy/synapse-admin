{% extends '@Synapse/admin/layout/base.html.twig' %}

{% block admin_page_title %}Audit & Logs | Sécurité | Synapse Administration Synapse
{% endblock %}

{% block admin_breadcrumb %}
	<span class="synapse-admin-topbar__breadcrumb-sep">›</span>
	<a href="#" class="synapse-admin-topbar__breadcrumb">Sécurité</a>
	<span class="synapse-admin-topbar__breadcrumb-sep">›</span>
	<span class="synapse-admin-topbar__current">Audit & Logs</span>
{% endblock %}

{% block admin_content %}

	<div class="synapse-admin-page-header">
		<div class="synapse-admin-page-header__info">
			<h1 class="synapse-admin-page-title">
				<span class="synapse-admin-page-title__icon synapse-admin-kpi__icon--warning">
					<i data-lucide="scroll-text"></i>
				</span>
				Journal d'audit
			</h1>
			<p class="synapse-admin-page-subtitle">
				Traces des échanges LLM (mode debug actif) et accès administrateurs.
			</p>
		</div>
		<div class="synapse-admin-page-header__actions">
			<span class="synapse-admin-badge synapse-admin-badge--neutral">
				<i data-lucide="database"></i>
				{{ total }}
				entrée{{ total > 1 ? 's' : '' }}
			</span>
		</div>
	</div>

	{# ── KPIs ─────────────────────────────────────────────────────────────────── #}
	<div class="synapse-admin-grid synapse-admin-grid--3 synapse-admin-mb-xl">
		<div class="synapse-admin-card synapse-admin-card--hover">
			<div class="synapse-admin-kpi">
				<div class="synapse-admin-kpi__icon synapse-admin-kpi__icon--warning">
					<i data-lucide="bug"></i>
				</div>
				<div class="synapse-admin-kpi__body">
					<div class="synapse-admin-kpi__label">Logs LLM enregistrés</div>
					<div class="synapse-admin-kpi__value">{{ total }}</div>
					<div class="synapse-admin-kpi__sub">traces debug en base</div>
				</div>
			</div>
		</div>
		<div class="synapse-admin-card synapse-admin-card--hover">
			<div class="synapse-admin-kpi">
				<div class="synapse-admin-kpi__icon synapse-admin-kpi__icon--info">
					<i data-lucide="eye"></i>
				</div>
				<div class="synapse-admin-kpi__body">
					<div class="synapse-admin-kpi__label">Affichés</div>
					<div class="synapse-admin-kpi__value">{{ logs|length }}</div>
					<div class="synapse-admin-kpi__sub">200 plus récents</div>
				</div>
			</div>
		</div>
		<div class="synapse-admin-card synapse-admin-card--hover">
			<div class="synapse-admin-kpi">
				<div class="synapse-admin-kpi__icon synapse-admin-kpi__icon--neutral">
					<i data-lucide="shield"></i>
				</div>
				<div class="synapse-admin-kpi__body">
					<div class="synapse-admin-kpi__label">Accès Break-Glass</div>
					<div class="synapse-admin-kpi__value">—</div>
					<div class="synapse-admin-kpi__sub">dans les logs système</div>
				</div>
			</div>
		</div>
	</div>

	{# ── Liens rapides ────────────────────────────────────────────────────────── #}
	<div class="synapse-admin-alert synapse-admin-alert--info synapse-admin-mb-xl">
		<i data-lucide="info"></i>
		<div>
			Les accès Break-Glass (historique des conversations) sont enregistrés dans
			        les
			<strong>logs Symfony</strong>
			(PSR Logger niveau warning).
			        Consultez
			<code>var/log/dev.log</code>
			ou votre agrégateur de logs pour les auditer.
			<br>Le journal ci-dessous concerne uniquement les
			<strong>traces d'échanges LLM</strong>
			(actives quand le
			<a href="{{ path('synapse_admin_settings') }}">mode debug</a>
			est activé).
		</div>
	</div>

	{# ── Tableau logs ─────────────────────────────────────────────────────────── #}
	{% if logs|length == 0 %}
		<div class="synapse-admin-card">
			<div class="synapse-admin-empty">
				<div class="synapse-admin-empty__icon">
					<i data-lucide="scroll-text"></i>
				</div>
				<div class="synapse-admin-empty__title">Aucun log d'audit</div>
				<p class="synapse-admin-empty__description">
					Activez le
					<a href="{{ path('synapse_admin_settings') }}">mode debug</a>
					pour enregistrer les traces LLM.
				</p>
			</div>
		</div>
	{% else %}
		<div class="synapse-admin-card">
			<div class="synapse-admin-card__header">
				<div class="synapse-admin-card__header-icon synapse-admin-kpi__icon--warning">
					<i data-lucide="list-ordered"></i>
				</div>
				<div>
					<div class="synapse-admin-card__title">Traces LLM récentes</div>
					<div class="synapse-admin-card__subtitle">200 dernières entrées · triées par date décroissante</div>
				</div>
				<div class="synapse-admin-card__header-actions">
					<a href="{{ path('synapse_admin_debug') }}" class="synapse-admin-btn synapse-admin-btn--ghost synapse-admin-btn--sm">
						<i data-lucide="external-link"></i>
						Vue complète
					</a>
				</div>
			</div>
			<div class="synapse-admin-table-container">
				<table class="synapse-admin-table">
					<thead>
						<tr>
							<th>ID Debug</th>
							<th>Module</th>
							<th>Modèle</th>
							<th>Tokens</th>
							<th>Date</th>
							<th class="synapse-admin-table__cell--actions">Rapport</th>
						</tr>
					</thead>
					<tbody>
						{% for log in logs %}
							{% set data = log.data ?? {} %}
							<tr>
								<td class="synapse-admin-table__cell--mono synapse-admin-text-xs">{{ log.debugId|slice(0, 8) }}…</td>
								<td>
									<span class="synapse-admin-badge synapse-admin-badge--neutral">{{ data.module ?? '—' }}</span>
								</td>
								<td class="synapse-admin-table__cell--mono synapse-admin-text-xs">{{ data.model ?? '—' }}</td>
								<td class="synapse-admin-table__cell--mono">
									{% set t = data.usage ?? data.token_usage ?? null %}
									{{ t ? (t.total_tokens ?? (t.prompt_tokens ?? 0) + (t.completion_tokens ?? 0)) : '—' }}
								</td>
								<td class="synapse-admin-table__cell--muted">
									{{ log.createdAt is defined ? log.createdAt|date('d/m H:i:s') : '—' }}
								</td>
								<td class="synapse-admin-table__cell--actions">
									<a href="{{ path('synapse_debug_show', {id: log.debugId}) }}" class="synapse-admin-btn synapse-admin-btn--ghost synapse-admin-btn--sm synapse-admin-btn--icon" target="_blank" data-synapse-admin-tooltip="Rapport détaillé">
										<i data-lucide="external-link"></i>
									</a>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	{% endif %}

{% endblock %}
